# 2_8_ClickHouse
## Задание
Расчет кумулятивной выручки и среднего чека по категориям товаров с использованием оконных функций  
Вам нужно будет создать или использовать следующие поля в таблице:  
__category__ (категория товара): Это поле будет содержать информацию о категории товара, по которой вы будете группировать данные.  
__order_date__ (дата заказа): Это поле будет содержать дату каждого заказа.  
__revenue__ (выручка): Это поле будет содержать сумму выручки для каждой продажи.  
__cumulative_revenue__ (кумулятивная выручка): Это поле будет содержать результаты расчета кумулятивной выручки с использованием оконных функций.  
__cumulative_orders__ (кумулятивное количество заказов): Это поле будет содержать кумулятивное количество заказов для каждой категории товаров.  
__average_check__ (средний чек): Это поле будет содержать результаты расчета среднего чека с использованием оконных функций.  
__max_avg_check_date__ (дата максимального среднего чека): Это поле будет содержать дату, на которой был достигнут максимальный средний чек.  
__max_avg_check_value__ (значение максимального среднего чека): Это поле будет содержать значение максимального среднего чека для каждой категории товаров.  
Описание:
У вас есть таблица sales с данными о продажах товаров. Ваша задача — рассчитать кумулятивную выручку и средний чек для каждой категории товаров с использованием оконных функций ClickHouse. Это задание включает в себя следующие шаги:
- Расчет кумулятивной выручки:
Для каждой категории товаров (category) вычислите кумулятивную выручку на каждый день. Это означает, что для каждой даты вам нужно будет посчитать сумму выручки для данной категории товаров на эту дату и для всех предыдущих дат.
- Расчет среднего чека:
Для каждой категории товаров на каждый день вычислите средний чек, который равен кумулятивной выручке на этот день, поделенной на кумулятивное количество заказов на этот день.
- Определение даты максимального среднего чека:
Найдите дату, на которой был достигнут максимальный средний чек для каждой категории товаров, а также значение этого максимального среднего чека.

## Решение
1. Создаем временную таблицу subselect, в которой расчитываем сумму продаж по категориям и кол-во продаж,
   используя функцию ClickHouse intDivOrZero рассчитываем средние продажи по категориям,
   все коммулятивные расчетные значения упорядочены по датам  
WITH subselect AS (  
  SELECT  
    order_date,  
    category,  
    SUM(revenue) OVER (PARTITION BY category ORDER BY order_date) AS cumulative_revenue,  
    COUNT(*) OVER (PARTITION BY category ORDER BY order_date) AS cumulative_orders,  
    /* Подстраховываемся функцией, которая при делении на 0 возвращает 0 */  
    intDivOrZero(cumulative_revenue, cumulative_orders) AS average_check   
  FROM sales  
)  
2. На базе subselect рассчитываем величину и дату максимальной средней выручки по категориям  
SELECT  
    order_date,  
    category,  
    cumulative_revenue,  
    cumulative_orders,  
    average_check,  
    argMax(order_date, average_check) OVER (PARTITION BY category) AS max_avg_check_date,  
    MAX(average_check) OVER (PARTITION BY category) AS max_avg_check_value                   
FROM subselect  
ORDER BY category, order_date
